% ==========================================================
%  fujishimalab-slide.sty
%  Hiroshima University — Fujishima Laboratory
%  Custom Beamer Theme for Technical Presentations
% ==========================================================

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{fujishimalab-slide}[2025/11/27 v1.1 Fujishima Lab Slide Theme + Chapter Slide]

% ==========================================================
% Basic packages
% ==========================================================
\RequirePackage{luatexja}
\RequirePackage{luatexja-fontspec}
\RequirePackage{tikz}
\usetikzlibrary{calc}

% ==========================================================
% Fonts (Japanese = Noto Sans CJK JP, English = Latin Modern Sans)
% ==========================================================
\setmainjfont{Noto Sans CJK JP}
\setsansjfont{Noto Sans CJK JP}

\setmainfont{Latin Modern Sans}
\setsansfont{Latin Modern Sans}

% ==========================================================
% Colors
% ==========================================================
\definecolor{hiroshimaGreen}{RGB}{25,149,65}
\definecolor{hiroshimaBlue}{RGB}{56,108,175}

% ==========================================================
% Margins
% ==========================================================
\setbeamersize{text margin left=4mm, text margin right=4mm}

% ==========================================================
% Metadata commands （ユーザ入力）
% ==========================================================
\newcommand{\fjslidetitle}[1]{\def\fjs@title{#1}}
\newcommand{\fjslideauthor}[1]{\def\fjs@author{#1}}
\newcommand{\fjslideinstitute}[1]{\def\fjs@institute{#1}}
\newcommand{\fjslidedate}[1]{\def\fjs@date{#1}}
\newcommand{\fjslideevent}[1]{\def\fjs@event{#1}} % default = blank
\def\fjs@event{}

% ==========================================================
% Title page design（No top/bottom bars）
% ==========================================================
\defbeamertemplate*{title page}{fujishima}{
    \vspace*{6mm}

    {\centering\Huge\bfseries\fjs@title\par}

    \vspace{5mm}

    % Central green bar
    \begin{tikzpicture}[remember picture, overlay]
        \fill[hiroshimaGreen]
            (current page.west)
            rectangle
            ($(current page.east)+(0,3mm)$);
    \end{tikzpicture}

    \vspace{8mm}

    {\centering\Large\fjs@author\par}
    \vspace{2mm}
    {\centering\large\fjs@institute\par}
    \vspace{4mm}
    {\centering\large\fjs@date\par}
}

% Disable header/footer for title slide
\newcommand{\fjsnotitleheader}{
    \setbeamertemplate{headline}{}
    \setbeamertemplate{footline}{}
}

% ==========================================================
% Normal slide design (2nd page and onward)
% ==========================================================

% frametitle
\setbeamercolor{frametitle}{fg=black,bg=white}

\setbeamertemplate{frametitle}{
    \vspace*{0mm}

    {\Large\bfseries\insertframetitle}

    \begin{tikzpicture}[remember picture, overlay]
        % Blue bar (3mm)
        \fill[hiroshimaBlue]
            ($(current page.north west)+(0,-10mm)$)
            rectangle
            ($(current page.north west)+(3mm,-13mm)$);

        % Green bar (3mm)
        \fill[hiroshimaGreen]
            ($(current page.north west)+(6mm,-10mm)$)
            rectangle
            ($(current page.north east)+(0,-13mm)$);
    \end{tikzpicture}

    \vspace*{0mm}
}

% Footer
\setbeamertemplate{footline}{
    \begin{tikzpicture}[remember picture, overlay]
        \fill[hiroshimaGreen]
            (current page.south west)
            rectangle
            ($(current page.south east)+(0,3mm)$);

        \node[anchor=west, text=white, font=\scriptsize]
            at ($(current page.south west)+(2mm,1.5mm)$)
            {\fjs@date};

        \node[anchor=center, text=white, font=\scriptsize]
            at ($(current page.south)+(0,1.5mm)$)
            {\fjs@event};

        \node[anchor=east, text=white, font=\scriptsize]
            at ($(current page.south east)+(-2mm,1.5mm)$)
            {\insertframenumber};
    \end{tikzpicture}
}

% No navigation symbols
\setbeamertemplate{navigation symbols}{}

% ============================================================
% Fujishima Lab Beamer Style (追加パッチ)
% frametitle spacing + subitem formatting
% ============================================================

\makeatletter

% frametitle 下の余白
\addtobeamertemplate{frametitle}{}{\vspace*{-1em}}

% 第二階層 itemize 小さめ
\usepackage{etoolbox}
\AtBeginEnvironment{itemize}{%
  \ifnum\@itemdepth=2
    \footnotesize
  \fi
}

% 数式余白調整
\apptocmd{\normalsize}{%
  \setlength{\abovedisplayskip}{6pt}%
  \setlength{\belowdisplayskip}{6pt}%
  \setlength{\abovedisplayshortskip}{4pt}%
  \setlength{\belowdisplayshortskip}{4pt}%
}{}{}

\makeatother

% ==========================================================
% Chapter Slide Template (Section Divider)
% ==========================================================
\newcommand{\fjschapterslide}[1]{%
  {
    \begingroup
    \setbeamertemplate{headline}{}
    \setbeamertemplate{footline}{}
    \setbeamertemplate{frametitle}{}  % ←これが決定的に重要

    \begin{frame}[plain]
        \vspace*{22mm}
        {\centering\Huge\bfseries #1\par}
        \vspace*{12mm}

        % optional green bar
        \begin{tikzpicture}[remember picture, overlay]
            \fill[hiroshimaGreen]
                ($(current page.west)+(0,-4mm)$)
                rectangle
                ($(current page.east)+(0,-1mm)$);
        \end{tikzpicture}

    \end{frame}

    \endgroup
  }
}

% ==========================================================
% End of style file
% ==========================================================



